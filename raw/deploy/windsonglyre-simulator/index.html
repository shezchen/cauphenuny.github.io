<!DOCTYPE HTML>
<html>
  <head>
    <meta charset="UTF-8" >
    <title>原琴模拟器</title>
    <link rel="icon" type="image/x-icon" href="./icon.jpg">
  </head>
  <body>
    <p id="bpm"></p>
    <p id="vel"></p>
    <p id="key_offset"></p>
    <p><label for="input">输入自动演奏内容：</label></p>
    <p><textarea id="input" name="input" rows="10" cols="80"></textarea></p>
    <p><button id="start">开始</button></p>
    <br>
    <p>预设：</p>
    <p><button id="haruhikage">春日影</button></p>
  </body>
  <script type="module">
    import { Soundfont2Sampler } from "https://unpkg.com/smplr/dist/index.mjs";
    import { SplendidGrandPiano } from "https://unpkg.com/smplr/dist/index.mjs";

    const key = 'ZXCVBNMASDFGHJQWERTYU'; // 键位
    const diff = [2, 2, 1, 2, 2, 2, 1]; // 自然大调音阶
    const velocites = [120, 32, 48, 56, 64, 72, 80, 88, 96, 108]; // 力度分级
    const key2note = new Map();
    const C1 = 48, C2 = 60, C3 = 72;
    for (var i = 0, note = C1; i < key.length; i++) {
        key2note.set(key.charCodeAt(i), note);
        note += diff[i % 7];
    }
    const context = new AudioContext();
    const piano = new SplendidGrandPiano(context);
    var vel = velocites[4];
    var offset = 0;
    var bpm = 90;
    document.getElementById("bpm").innerHTML = "bpm: " + bpm;
    document.getElementById("vel").innerHTML = "力度: " + vel;
    document.getElementById("key_offset").innerHTML = "移调: " + offset;
    function stroke(code) {
        piano.start({ note: code + offset, velocity: Math.round(vel - (C3 - code) / 2) });
    }
    document.addEventListener("keydown", function(event) {
        var code = event.keyCode;
        console.log(code, key2note.get(code));
        if (key2note.has(code)) {
            stroke(key2note.get(code));
        }
        if (code >= 48 && code <= 57) {
            vel = velocites[code - 48];
            document.getElementById("vel").innerHTML = "力度: " + vel;
        }
        if (code == 189) {
            offset--;
            document.getElementById("key_offset").innerHTML = "移调: " + offset;
        }
        if (code == 187) {
            offset++;
            document.getElementById("key_offset").innerHTML = "移调: " + offset;
        }
    });
    function sleep(milliseconds) {
      return new Promise(resolve => {
        setTimeout(resolve, milliseconds);
      });
    }
    async function play(music) {
        var interval = 60 * 1000 / bpm / 4;
        var cnt = 0;
        for (var i = 0; i < music.length; i++) {
            var key = music.charCodeAt(i);
            //console.log(i, music[i], key);
            if (key2note.has(key)) {
                //console.log("note", music[i]);
                stroke(key2note.get(key));
                cnt++;
                await sleep(interval);
            } else if (music[i] == '(') {
                //console.log("chord", music[i + 1]);
                while (music[++i] != ')') {
                    stroke(key2note.get(music.charCodeAt(i)));
                }
                cnt++;
                await sleep(interval);
            } else if (music[i] == ' ' || music[i] == ' ') {
                //console.log("interval on ", i);
                if (music[i] == ' ') {
                    console.log("special space");
                }
                cnt++;
                await sleep(interval);
            } else if (music[i] == '/') {
                console.log(cnt);
                cnt = 0;
            } else {
                //console.log("ignore ", music[i]);
            }
        }
    }
    document.getElementById("haruhikage").onclick = () => {
        //stroke();
        document.getElementById("input").innerHTML = haruhikage;
        //play(haruhikage);
        //console.log(sampler.instrumentNames);
        //context.resume(); // enable audio context after a user interaction
    };
    document.getElementById("start").onclick = () => {
        var music = document.getElementById("input").value;
        play(music);
    };

    var haruhikage = `
前奏：

(AGE)   W /Q   W /(VAE)  RE /W N M /
(AGE) S W /(GQ)   (AW) /(VADE)  R(AE) /(FW)     /
(ZE) B (AW) /(SQ)   (AW) /(VE) ZR(AE) /(SW)   A /
(ZE) B (AW) /(SQ)   (AW) /(VE) ZR(AE) /(SW)   (VA)A/

主歌：

(ZD) (BD) S /(AF) D (BS) /(VS) (ZS) AA/(SF) D (VS) /
(ZS) B AS/(AD)   B /(CA)   A /(BD) G (DQ) /
(VJ) Z (AQ) /(GJ)   (DQ) /(BJ)H(XG) M /(DG) S (SF) /
(CAF) Z (BD) /(AD)   (ZB) /(CAF) D (ZS) /(BD)   (DG) /

(VA) Z N /(BM) X A /(CNS) A  M/(XBA) G (BA) /
(VF) Z (AD) /(BS) (XA) A /(ZA) B A /S A (BA)S/
(ZD) (BD) S /(AF) D (BS) /(VS) (ZS) A /(SF) D (VS) /
(ZS) B AS/(AD)   B /(CA)   A /(BD) G (DQ) /

(VJ) Z (AQ) /(GJ)   (DQ) /(BJ)H(XG) M /(DG) S (SF) /
(CAF) (ZD) (BD) /(AD)   (ZB) /(CAF) D (ZS) /(BD)   (DG) /
(VA) Z N /(BM) X AA/(CNS) A   /(XBA) G (BA) /
(VF) (ZF)F(AD)S/(BS) (XA) A /(ZA) B A /D     /

(VAH) G G /G F F /(BD) S S /S   G /
(CSG) FFF /F D S /(CNS) A AM/A     /
(VAH) G G /G F F /(BD) S S /S   D /
(CSF) DDDD/D S D /(NGW) D (AQ) /(BSQ) A (BQ) /

(ZVJ) (ZH) (VH) /(DH) A V /(ZV) Z (VH) /(DH) (AG) (VF)F/

副歌：

(ZD)S(BD)SDF/(ADG) S (BF)G/(ZVH) Z HJ/(AFQ) N (VW)Q/
(CBG) C B /(MSG) (BF) (CF) /(CND) C (NF)D/(ADG) S B /

(ZD)S(BD)SD /(ADG) S (BF)G/(ZVH) Z AH/(CMJ) C DD/
(CBE) (CE) ME/(DGR) E (MW) /(CNW) C QJ/(ADQ) S (XBG)Q/

(ZVW) (ZQ) (AQ) /(FQ) A (VG) /(XBW) (XQ) (SQ) /(GQ) S (BG)Q/
(ZBW) (ZQ) (BQ) /(ADQ) A (BG)Q/(ZBW) AE(DW) /(GQ) A (BQ) /

(ZVJ) (ZH) (AH) /(FH) A (VG) /(XBG) X (MF) /(SF) (MD) (BS) /
(ZBD) B A /S A B /(ZVD) (NF) (AD) /(XBF) (XD) (MS) /

(ZBA) AZB /(ZBS)   (ZA) /(ZB) AZB /F D AS/

主歌：

(ZBD) D S /F D S /(ZVS) S AA/(SF) (AD) (VS) /
(ZS) B AS/(AD)   B /(CA)   A /(BD) G (DQ) /
(VJ) Z (AQ) /(GJ)   (DQ) /(BJ)H(XG) M /(DG) S (SF) /
(CAF) (ZD) (BD) /(AD)   Z /(CAF) D (ZS) /(BD)   (DG) /

(VA) Z N /(BM) X AA/(CNS) A   /(XBA) G (BA) /
(VF) Z (AD) /(BS) X A /(ZA) B A /S A B /

(VAH) G G /G F F /(BD) S S /S   G /
(CSG) FFF /F D S /(CNS)   AM/A     /
(VAH) G G /G F F /(BD) S S /S   D /
(CSF) DDDD/D S D /(NGW) D (AQ) /(BSQ) A (BQ) /

(ZVJ) Z (VH) /(DH) A V /(ZV) Z (VH) /(DH) (AG) (VF)F/
(XBF) X (BD) /(SD)F(BG) X /(XB) X B /(MS) B (XB) /

间奏：

(ZVF) (ZH)Q(VE) /(AD) (AQ) (VF) /(ZVF) (ZH) (VE) /(AD) (AH) (VF) /
(ZBQ) Z (BQ)W/(ADW) A (BW)Q/(ZBQ) Z (BQ) /(ADQ) (AQ) (BQ) /
(ZVF) (ZH)Q(VE) /(AD) (AQ) (VF) /(ZVF) (ZH) (VE) /(AD) (AH) (VF) /
(ZBQ) Z (BQ)W/(ADW) A (BW)Q/(ZBQ) Z (BQ)E/(ADE) A (BE)W/

桥段：

(ZVW)Q(ZQ)Q(VQ)Q/(ADE) (AQ) V /(ZVW)Q(ZQ)Q(VQ)Q/(ADW) (AQ) (VQ)H/
(ZBG) (ZE) B /(AD) A B /(ZB) Z B /(AD) A B /
(ZVW)Q(ZQ)Q(VQ)Q/(ADE) (AQ) V /(ZVW)Q(ZQ)Q(VQ)Q/(ADW) (AQ) (VQ)H/
(ZBG) (ZE) (BW) /(ADW) A B /(XBW)W(XW) (BG)G/(ADW) A (BQ) /

(VAQ)     /Q Q Q /(AQ)QW Q /WWQ   /
(BS)     /(JW) (JW)(HQ)(JW) /(BSW) (BSE) (BSW) /(XBE) (XB) (BR) /

间奏：

(ZBGE) Z B /(AD) A B /(ZV) Z V /(AD) A V /
(CBT) (CT) (MT) /(DGT) (ME) (CW) /(CNQ) (CJ) (NJ) /(ADJ) (NJ) (CJ) /
(ZBE) Z (BW) /(ADW) (AQ) (BG) /(ZVH) Z V /(CM) C M /
(MD) M C /(MJ) (CJ) (MJ) /(MDQ) (MDJ) (MD)G/(CMG) (CS) (CD) /

副歌：

(ZD)S(BD)SDF/(ADG) S (BF)G/(ZVH) Z HJ/(AFQ) N (VW)Q/
(CBG) C B /(MSG) (BF) (CF) /(CND) C (NF)D/(ADG) S B /

(ZD)S(BD)SD /(ADG) S (BF)G/(ZVH) Z AH/(CMJ) C DD/
(CBE) (CE) ME/(DGR) E (MW) /(CNW) C QJ/(ADQ) S (XBG)Q/

(ZVW) Z (AQ) /(FQ) A (VG) /(ZBW) Z (BQ) /(ADQ) A (BG)Q/
(ZVW) (ZQ) (VQ) /(ADQ) A (VG)Q/(ZBW) AE(DW) /(GQ) A (BQ) /

(ZVJ) (ZH) (AH) /(FH) A (VG) /(XBG) X (MF) /(SF) (MD) (BS) /
(ZBD) B A /S A B /(ZVD) (NF) (AD) /(XBF) (XD) (MS) /

(ZBA) AZB /(ZBS)   (ZA) /(ZVF) (NF) A /(XBG) X (MQ) /
(ZBQ) AZB /(ZBS)   (ZA) /(ZVQ) (NW) (AQ) /(XBW) (XQ) (MW) /

(AGQE)   W /Q   W /(VAE)  RE /W N M /(AGE) S W /
(GQ)   (AW) /(VADE)  RE /(FW)     /      /(ZBDQ)      / 
`
    var komorebi = `
(VH) AE/D W /(BDJT)   /(JE)   /
(NGW) AE/D (GQ) /(CGJ) M /(SG)  /
(VH) (AE) /D JQ/(BJ) XG/B S /
(NAD) C /N A /(BM) C /B X /

(VH) AE/D (AW) /(BT) M /(SE) M /
(NW) AE/D (GQ) /(CJ) M /(DG) M /
(VH) (AE) /D JQ/(BJ) XG/B S /
(NAD) C /N A /(BM)  /    /

a1段：

(VH) AE/D (AW) /(BT) M /(SE) M /
(NW) AE/D (GQ) /(CJ) M /(DG) M /
(VDH) (AHE) /D SD/(BSG) (MGE) /S (MG)J/
(NDH) (AHE) /D (AH)E/(CDH) (MHE) /D (MH)E/

(VH) AE/D (AW) /(BT) M /(SE) M /
(NW) AE/D (GQ) /(CJ) M /(DG) M /
(VDH) (AHE) /FGHQ /(BSGJ) X /MSGJ /
(NDQ) A /(DH)J(GQ)T /(CJET) M /(DH)J(MW)T /

b段：

(VQ) A(GQ) /D (AQ) /(BJ) MJ/SHM /
(NHQ) A(HQ) /D(GQ) (GJ)/C M /(DG)J(MW)T /
(VGQ) A(QY)/ Q W /(BWTU) XQ/UTWE /
(NW) AQ/DWGE /C MG/(DJ)W(MT)J /

(VGQ) A(QT)/DQA /(BJW) M /(SH)J(MW)T /
(NGQ) A(GQ)/D Q(QT)/CU(MQ)W /(DU)T(MW)T /
(VQEY) AQ/ FGQ /(BGJ) X(JT)/ JWQ /
(NQT) (AD)G/DG(AH)Q /(CD)G(MH)J /(DQ)T(MG)J /

(VQ) A(QT)/DQA /(BW) M /SH(MG)H /
(NQ) A(HQ)/D GQ/(CGJ) M /(DG)J(MW)T /
(VGQ) A(QY)/ Q W/(BWTU) XQ/UTWE /
(NW) AQ/DWGE /C MG/(DJ)W(MT)J /

(VGQ) A(QT)/DQA /(BJW) M /(SH)J(MW)T /
(NGQ) A(GQ)/D Q(QT)/CU(MQ)W /(DU)T(MW)T /
(VQEY) AQ/ FGQ/(BGJ) X(JT)/ JWQ/
(NQT) (AD)G/DG(AH)Q /(CGJ) M /HJ(MW)T /

a1段：

(VH) AE/D (AW) /(BT) M /(SE) M /
(NW) AE/D (GQ) /(CJ) M /(DG) M /
(VDH) (AHE) /D SD/(BSG) (MGE) /S (MG)J/
(NDH) (AHE) /D (AH)E/(CDH) (MHE) /D (MH)E/

(VH) AE/D (AW) /(BT) M /(SE) M /
(NW) AE/D (GQ) /(CJ) M /(DG) M /
(VDH) (AHE) /FGHQ /(BSGJ) X /MSGJ /
(NDQ) A /(DH)J(GQ)T /(CJET) M /(DH)J(MW)T /

c段：

(VWY) (AWY)(QT) /D(WT)(AE)Q /(BHE)WMW /(SGQ) (MGQ)J /
NJ(AG) /D AG/(CSG) (MSG)A/D(AG)M /
(VWY) (AWY)(QT) /D(WT)(AE)Q /(BHE)WMW /(SGQ) (MGQ)J /
N(GJ)(AHQ) /DQ(GU)Q /CU(MT)W /(DQ)J(MG)S /

(VQT) (AQT)Q /DWA /(BG)JM(JT) /(SGQ) (MGW) /
(NHE) (AHE)W /DQA /C(GJ)M(GJ) /(DGQ) (MGW) /
(VQT) A(QT) /D A /(BJT) M(JT) /S M /
(NQT) A(QT) /D G /(CJT) M(JT) /(DG)J(MW)T /

a1段：

(VH) AE/D (AW) /(BT) M /(SE) M /
(NW) AE/D (GQ) /(CJ) M /(DG) (MH)G /
(VDH) (AHE) /D SD/(BSG) (MGE) /S (MG)J/
(NDH) (AHE) /D (AH)E/(CDH) (MHE) /D (MH)E/

(VH) AE/D (AW) /(BT) M /(SE) M /
(NW) AE/D (GQ) /(CJ) M /(DG) (MH)G /
(VDH) (AHE) /FGHQ /(BSGJ) X /MSGJ /
(NDQ) A /(DH)J(GQ)T /(CJET) M /(DH)J(MW)T /
`
  </script>

<a href="https://cauphenuny.github.io/2024/06/14/build-a-windsonglyre-simulator/">development log</a>
</html>
