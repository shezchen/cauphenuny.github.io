<!DOCTYPE HTML>
<html>
  <head>
    <meta charset="UTF-8" >
    <link rel="icon" type="image/x-icon" href="./icon.jpg">
    <title>原琴模拟器</title>
    <h2>原琴模拟器</h2>
  </head>
  <body>
    <form>
      <p id="status" style="color: red;"><b>加载中，请稍候……</b></p>
      <p id="vel"></p>
      <label for="bpm">bpm：</label>
      <input type="text" id="bpm" size=8><br>
      <label for="key_offset">移调：</label>
      <input type="text" id="key_offset" size=2><span id="key_name"></span><br>
      <label for="time_sign1">拍号：</label>
      <input type="text" id="time_sign1" size=2>/<input type="text" id="time_sign2" size=2><br>
      <input type="button" value="确定" id="submit">
    </form>
      <p><label for="input">输入谱子：</label></p>
      <p><textarea id="input" name="input" rows="16" cols="60"></textarea></p>
      <p><button id="start">演奏</button> <button id="stop">停止</button></p>
    <p>预设：</p>
    <p><button id="haruhikage">春日影</button> 
       <button id="reset">复原</button>
    </p>
  </body>
  <script type="module">
    import { Soundfont2Sampler } from "https://unpkg.com/smplr/dist/index.mjs";
    import { SplendidGrandPiano } from "https://unpkg.com/smplr/dist/index.mjs";

    const key = 'ZXCVBNMASDFGHJQWERTYU'; // 键位
    const note_name = ["C", "C<sup>♯</sup>/D<sup>♭</sup>", "D", "D<sup>♯</sup>/E<sup>♭</sup>", "E", "F", "F<sup>♯</sup>/G<sup>♭</sup>", "G", "G<sup>♯</sup>/A<sup>♭</sup>", "A", "A<sup>♯</sup>/B<sup>♭</sup>", "B"];
    const diff = [2, 2, 1, 2, 2, 2, 1]; // 自然大调音阶
    const velocites = [32, 48, 56, 64, 68, 72, 80, 88, 96, 108]; // 力度分级
    const key2note = new Map();
    const C1 = 48, C2 = 60, C3 = 72;
    for (var i = 0, note = C1; i < key.length; i++) {
        key2note.set(key.charCodeAt(i), note);
        note += diff[i % 7];
    }
    const context = new AudioContext();
    const piano = new SplendidGrandPiano(context);
    piano.load.then(() => {
        document.getElementById("status").style = "color: green;";
        document.getElementById("status").innerHTML = "准备就绪";
        init();
        refresh();
    });
    var vel, offset, bpm, time1, time2;
    function init() {
        vel = 4;
        offset = 0;
        bpm = 90;
        time1 = 4, time2 = 4;
        document.getElementById("input").innerHTML = "";
        refresh();
    }
    document.getElementById("submit").onclick = () => {
        bpm = parseInt(document.getElementById("bpm").value);
        offset = parseInt(document.getElementById("key_offset").value);
        time1 = parseInt(document.getElementById("time_sign1").value);
        time2 = parseInt(document.getElementById("time_sign2").value);
        console.log(bpm, offset, time1, time2);
        refresh();
    }
    function refresh() {
        document.getElementById("bpm").value = bpm;
        document.getElementById("vel").textContent = "力度：" + velocites[vel];
        document.getElementById("key_offset").value = offset;
        document.getElementById("key_name").innerHTML = " (" + note_name[(offset + 120) % 12] + ")";
        document.getElementById("time_sign1").value = time1;
        document.getElementById("time_sign2").value = time2;
    }
    function stroke(code, tim, velc) {
        piano.start({ note: code + offset, velocity: Math.round(velocites[velc] - (C3 - code) / 2), time: tim }); // 使高音强，低音弱
    }
    document.addEventListener("keydown", function(event) {
        var code = event.keyCode;
        console.log(code, key2note.get(code));
        if (key2note.has(code)) {
            stroke(key2note.get(code), context.currentTime, vel);
        }
        if (code == 189) {
            if (vel > 0) vel--; 
            refresh();
        }
        if (code == 187) {
            if (vel < 9) vel++;
            refresh();
        }
    });
    function sleep(milliseconds) {
      return new Promise(resolve => {
        setTimeout(resolve, milliseconds);
      });
    }
    document.getElementById("stop").onclick = () => {
        console.log("stop");
        piano.stop();
    }
    function play(music) {
        var interval = 60 * 4 / bpm / time2;
        var velc = vel;
        var stack = [];
        stack.push(1);
        var cnt = 0;
        var sum = 0;
        var now = context.currentTime;
        var getTop = arr => arr[arr.length - 1];
        for (var i = 0; i < music.length; i++) {
            var key = music.charCodeAt(i);
            //console.log(i, music[i], key);
            switch (music[i]) {
                case '(':
                    //console.log("chord start", music[i + 1]);
                    stack.push(0);
                    break;
                case ')':
                    stack.pop();
                    cnt += getTop(stack);
                    sum += getTop(stack);
                    //console.log("chord end");
                    break;
                case '[':
                    stack.push(getTop(stack) / 2);
                    break;
                case ']':
                    stack.pop();
                    break;
                case '{':
                    stack.push(getTop(stack) / 4);
                    break;
                case '}':
                    stack.pop();
                    break;
                case '-':
                    if (velc > 0) velc--;
                    break;
                case '+':
                    if (velc < 9) velc++;
                    break;

                case '/':
                    //console.log(cnt);
                    cnt = 0;
                    break;

                case ' ':
                    //console.log("special space");
                case ' ':
                    //console.log("interval", interval, sum);
                    cnt += getTop(stack);
                    sum += getTop(stack);
                    break;

                default:
                    if (key2note.has(key)) {
                        stroke(key2note.get(key), now + sum * interval, velc);
                        cnt += getTop(stack);
                        sum += getTop(stack);
                        //cnt++, sum++;
                    }
                    break;
            }
        }
    }
    document.getElementById("haruhikage").onclick = () => {
        bpm = 90;
        time1 = 3;
        time2 = 16;
        offset = -1;
        document.getElementById("input").value = haruhikage;
        refresh();
        //play(haruhikage);
        //console.log(sampler.instrumentNames);
        //context.resume(); // enable audio context after a user interaction
    };
    document.getElementById("reset").onclick = () => {
        init();
    };
    document.getElementById("start").onclick = () => {
        console.log("click");
        //getAttribute();
        play(document.getElementById("input").value);
    };

    var haruhikage = `前奏：

(AGE)   W /Q   W /(VAE)  RE /W N M /
(AGE) S W /(GQ)   (AW) /(VADE)  R(AE) /(FW)     /
(ZE) B (AW) /(SQ)   (AW) /(VE) ZR(AE) /(SW)   A /
(ZE) B (AW) /(SQ)   (AW) /(VE) ZR(AE) /(SW)   (VA)A/

主歌：

(ZD) (BD) S /(AF) D (BS) /(VS) (ZS) AA/(SF) D (VS) /
(ZS) B AS/(AD)   B /(CA)   A /(BD) G (DQ) /
(VJ) Z (AQ) /(GJ)   (DQ) /(BJ)H(XG) M /(DG) S (SF) /
(CAF) Z (BD) /(AD)   (ZB) /(CAF) D (ZS) /(BD)   (DG) /

(VA) Z N /(BM) X A /(CNS) A  M/(XBA) G (BA) /
(VF) Z (AD) /(BS) (XA) A /(ZA) B A /S A (BA)S/
(ZD) (BD) S /(AF) D (BS) /(VS) (ZS) A /(SF) D (VS) /
(ZS) B AS/(AD)   B /(CA)   A /(BD) G (DQ) /

(VJ) Z (AQ) /(GJ)   (DQ) /(BJ)H(XG) M /(DG) S (SF) /
(CAF) (ZD) (BD) /(AD)   (ZB) /(CAF) D (ZS) /(BD)   (DG) /
(VA) Z N /(BM) X AA/(CNS) A   /(XBA) G (BA) /
(VF) (ZF)F(AD)S/(BS) (XA) A /(ZA) B A /D     /

(VAH) G G /G F F /(BD) S S /S   G /
(CSG) FFF /F D S /(CNS) A AM/A     /
(VAH) G G /G F F /(BD) S S /S   D /
(CSF) DDDD/D S D /(NGW) D (AQ) /(BSQ) A (BQ) /

(ZVJ) (ZH) (VH) /(DH) A V /(ZV) Z (VH) /(DH) (AG) (VF)F/
(XBF) X (BD) /(SD)F(BG) X /(XB) X B /(MS) B (XB) /

副歌：

(ZD)S(BD)SDF/(ADG) S (BF)G/(ZVH) Z HJ/(AFQ) N (VW)Q/
(CBG) C B /(MSG) (BF) (CF) /(CND) C (NF)D/(ADG) S B /

(ZD)S(BD)SD /(ADG) S (BF)G/(ZVH) Z AH/(CMJ) C DD/
(CBE) (CE) ME/(DGR) E (MW) /(CNW) C QJ/(ADQ) S (XBG)Q/

(ZVW) (ZQ) (AQ) /(FQ) A (VG) /(XBW) (XQ) (SQ) /(GQ) S (BG)Q/
(ZBW) (ZQ) (BQ) /(ADQ) A (BG)Q/(ZBW) AE(DW) /(GQ) A (BQ) /

(ZVJ) (ZH) (AH) /(FH) A (VG) /(XBG) X (MF) /(SF) (MD) (BS) /
(ZBD) B A /S A B /(ZVD) (NF) (AD) /(XBF) (XD) (MS) /

(ZBA) AZB /(ZBS)   (ZA) /(ZB) AZB /F D AS/

主歌：

(ZBD) D S /F D S /(ZVS) S AA/(SF) (AD) (VS) /
(ZS) B AS/(AD)   B /(CA)   A /(BD) G (DQ) /
(VJ) Z (AQ) /(GJ)   (DQ) /(BJ)H(XG) M /(DG) S (SF) /
(CAF) (ZD) (BD) /(AD)   Z /(CAF) D (ZS) /(BD)   (DG) /

(VA) Z N /(BM) X AA/(CNS) A   /(XBA) G (BA) /
(VF) Z (AD) /(BS) X A /(ZA) B A /S A B /

(VAH) G G /G F F /(BD) S S /S   G /
(CSG) FFF /F D S /(CNS)   AM/A     /
(VAH) G G /G F F /(BD) S S /S   D /
(CSF) DDDD/D S D /(NGW) D (AQ) /(BSQ) A (BQ) /

(ZVJ) Z (VH) /(DH) A V /(ZV) Z (VH) /(DH) (AG) (VF)F/
(XBF) X (BD) /(SD)F(BG) X /(XB) X B /(MS) B (XB) /

间奏：

(ZVF) (ZH)Q(VE) /(AD) (AQ) (VF) /(ZVF) (ZH) (VE) /(AD) (AH) (VF) /
(ZBQ) Z (BQ)W/(ADW) A (BW)Q/(ZBQ) Z (BQ) /(ADQ) (AQ) (BQ) /
(ZVF) (ZH)Q(VE) /(AD) (AQ) (VF) /(ZVF) (ZH) (VE) /(AD) (AH) (VF) /
(ZBQ) Z (BQ)W/(ADW) A (BW)Q/(ZBQ) Z (BQ)E/(ADE) A (BE)W/

桥段：

(ZVW)Q(ZQ)Q(VQ)Q/(ADE) (AQ) V /(ZVW)Q(ZQ)Q(VQ)Q/(ADW) (AQ) (VQ)H/
(ZBG) (ZE) B /(AD) A B /(ZB) Z B /(AD) A B /
(ZVW)Q(ZQ)Q(VQ)Q/(ADE) (AQ) V /(ZVW)Q(ZQ)Q(VQ)Q/(ADW) (AQ) (VQ)H/
(ZBG) (ZE) (BW) /(ADW) A B /(XBW)W(XW) (BG)G/(ADW) A (BQ) /

(VAQ)     /Q Q Q /(AQ)QW Q /WWQ   /
(BS)     /(JW) (JW)(HQ)(JW) /(BSW) (BSE) (BSW) /(XBE) (XB) (BR) /

间奏：

(ZBGE) Z B /(AD) A B /(ZV) Z V /(AD) A V /
(CBT) (CT) (MT) /(DGT) (ME) (CW) /(CNQ) (CJ) (NJ) /(ADJ) (NJ) (CJ) /
(ZBE) Z (BW) /(ADW) (AQ) (BG) /(ZVH) Z V /(CM) C M /
(MD) M C /(MJ) (CJ) (MJ) /(MDQ) (MDJ) (MD)G/(CMG) (CS) (CD) /

副歌：

(ZD)S(BD)SDF/(ADG) S (BF)G/(ZVH) Z HJ/(AFQ) N (VW)Q/
(CBG) C B /(MSG) (BF) (CF) /(CND) C (NF)D/(ADG) S B /

(ZD)S(BD)SD /(ADG) S (BF)G/(ZVH) Z AH/(CMJ) C DD/
(CBE) (CE) ME/(DGR) E (MW) /(CNW) C QJ/(ADQ) S (XBG)Q/

(ZVW) Z (AQ) /(FQ) A (VG) /(ZBW) Z (BQ) /(ADQ) A (BG)Q/
(ZVW) (ZQ) (VQ) /(ADQ) A (VG)Q/(ZBW) AE(DW) /(GQ) A (BQ) /

(ZVJ) (ZH) (AH) /(FH) A (VG) /(XBG) X (MF) /(SF) (MD) (BS) /
(ZBD) B A /S A B /(ZVD) (NF) (AD) /(XBF) (XD) (MS) /

(ZBA) AZB /(ZBS)   (ZA) /(ZVF) (NF) A /(XBG) X (MQ) /
(ZBQ) AZB /(ZBS)   (ZA) /(ZVQ) (NW) (AQ) /(XBW) (XQ) (MW) /

(AGQE)   W /Q   W /(VAE)  RE /W N M /(AGE) S W /
(GQ)   (AW) /(VADE)  RE /(FW)     /      /(ZBDQ)      / 

---
来源：https://www.bilibili.com/read/cv27118373/
略有修改，使节奏正确。
`
  </script>

v0.1.0<br>
风物之诗琴的音源没搞好，先用钢琴代替了<br>
<a href="https://cauphenuny.github.io/2024/06/14/build-a-windsonglyre-simulator/">开发日志</a>
</html>
